{% extends "_base_restaurants.html" %}
 {% load i18n static %}

{% block title %}
  {{ page_title }}
{% endblock title %}

{% block content %}
<div class="container">
    <div class="row mb-2 bg-dark text-light">
        <div class="col">
            <h1>{% trans "My Favorite places" %}</h1>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <!-- category -->
            <div class="mt-1">
                {% trans "Category" %}
                {% for cat in categories %}                    
                <a href="{% url 'restaurants:res_home' %}?category={{ cat }}{% if tag %}&tag={{ tag }}{% endif %}{% if city %}&city={{ city }}{% endif %}" class="badge rounded border border-primary {% if category == cat %} bg-primary text-light{% else %}text-secondary{% endif %}" style="text-decoration: none;">{{ cat }}</a>
                {% endfor %}
                {% if category %}
                <a href="{% url 'restaurants:res_home' %}?{% if tag %}&tag={{ tag }}{% endif %}{% if city %}&city={{ city }}{% endif %}" class="text-danger ms-3 lead" style="text-decoration: none;">x</a>
                {% endif %}
            </div>
            <!-- city -->
            <div class="mt-1">
                {% trans "City" %}
                {% for citi in cities %}
                <a href="{% url 'restaurants:res_home' %}?city={{ citi }}{% if tag %}&tag={{ tag }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="badge rounded border border-info {% if city == citi %}bg-info{% else %}text-secondary{% endif %}" style="text-decoration: none;">{{ citi }}</a>
                {% endfor %}
                {% if city %}
                <a href="{% url 'restaurants:res_home' %}?{% if tag %}&tag={{ tag }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="text-danger ms-3 lead" style="text-decoration: none;">x</a>
                {% endif %}
            </div>
            <!-- Tag -->
            <div class="mt-1">
                {% trans "Tags" %}
                {% for taag in tags %}                    
                    <a href="{% url 'restaurants:res_home' %}?tag={{ taag.slug }}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="badge rounded border border-success {% if tag == taag.slug %}bg-success text-light{% else %}text-secondary{% endif %}" style="text-decoration: none;">{{ taag.name }}</a>
                {% endfor %}
                {% if tag %}
                    <a href="{% url 'restaurants:res_home' %}?{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="text-danger ms-3 lead" style="text-decoration: none;">x</a>
                {% endif %}
            </div>
            
        </div>
    </div>
    {% for place in places %}
    <div class="row border rounded my-4">
        <div class="col">
            <div class="row">
                <div class="col-md-6">
                    <div class="row">
                        <div class="col">
                            <h2 class="">{{ place.name }}</h2>
                            {% if place.category %}
                            <a href="{% url 'restaurants:res_home' %}?category={{ place.category.slug }}{% if tag %}&tag={{ tag }}{% endif %}{% if city %}&city={{ city }}{% endif %}" class="text-secondary">[ {{ place.category.name }} ]</a>
                            {% endif %}                        
                            <a href="{% url 'restaurants:res_home' %}?city={{ place.city }}{% if tag %}&tag={{ tag }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="ms-1 text-secondary">[ {{ place.city }} ]</a>
                        </div>
                    </div>
                    <div>
                        {% for taag in place.tags.all %}                    
                           <a href="{% url 'restaurants:res_home' %}?tag={{ taag.slug }}{% if city %}&city={{ city }}{% endif %}{% if category %}&category={{ category }}{% endif %}" class="badge rounded border {% if tag == taag.slug %}bg-success text-light{% else %}border-success text-secondary{% endif %}" style="text-decoration: none;">{{ taag.name }}</a>
                        {% endfor %}                        
                    </div>
                    {% if place.description %}
                      {{ place.description | linebreaksbr }}
                    {% endif %}
                    <!-- Drive Link -->
                    {% if place.latitude and place.longitude %}
                    <div class="my-3">
                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ place.latitude }},{{ place.longitude }}" target="_blank" class="btn btn-sm btn-secondary">
                            Direction <img src="{% static 'img/arrows.png' %}" alt="" class="ms-2" width="20x" height="auto">
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% if place.latitude and place.longitude %}
                <div class="col-md-6 pe-md-0">
                    <!-- 
                      MAP CONTAINER:
                      - The ID must be unique for each map.
                      - data-* attributes hold the coordinates for our script.
                      - It MUST have a height to be visible.
                    -->
                    <div id="map-{{ place.uuid }}" 
                         data-lat="{{ place.latitude }}" 
                         data-lon="{{ place.longitude }}"
                         data-name="{{ place.name }}"
                         class="map-container" 
                         style="height: 300px; width: 100%; border-radius: 8px;">
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% empty %} 
    <div class="row border rounded my-4">
        <div class="col">
            <h2>{% trans "There is not any results" %}</h2>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock content %}

{% block script %}
<script>
// This script will run after the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function () {
    // Find all the map containers on the page
    const mapElements = document.querySelectorAll('.map-container');

    // Loop through each map container
    mapElements.forEach(function(mapDiv) {
        // Get the coordinates and name from the data-* attributes
        const lat = parseFloat(mapDiv.dataset.lat);
        const lon = parseFloat(mapDiv.dataset.lon);
        const name = mapDiv.dataset.name;
        const mapId = mapDiv.id;

        // 1. Create the map and set the initial view
        const map = L.map(mapId).setView([lat, lon], 15); // Zoom level 15 is good for city-level views

        // 2. Add the tile layer (the map background)
        // Using OpenStreetMap. It's free and open.
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // 3. Add a marker to the map
        const marker = L.marker([lat, lon]).addTo(map);

        // 4. (Optional) Add a popup to the marker
        marker.bindPopup(`<b>${name}</b>`).openPopup();
    });
});
</script>  
{% endblock script %}