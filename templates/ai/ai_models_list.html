{% extends "_base.html" %}
{% load crispy_forms_tags %}
{% load markdown_extras %} 

{% block content %}
<div class="container-fluid text-light">
    <div class="row">
        <div class="col-md-1">
            {% include "ai/chat_header.html" %}
            <table>
                {% for chat in chats %}
                <tr>
                    <td class="border p-2 border-secondary">
                        <a href="{% url 'ai:ai_continue_chat' chat.chat_id %}" >{{ chat.get_first_message }}</a>
                    </td>
                </tr>
                  
                {% endfor %}
            </table>
        </div>
        <div class="col-md-11">
            <div class="table-responsive">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Added</th>
                            <th>Model ID</th>
                            <th>Model Name</th>
                            <th>Owned by</th>
                            <th>Min Tier</th>
                            <th>Mode</th>
                            <th>Suported endpoint</th>
                            <th>Pricing</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in sorted_data %}
                        <tr id="{{ model.id }}">
                            <td>{{ forloop.counter }}</td>
                            <td>
                                {% if model.id in models_added %}
                                &#10004;
                                {% else %}
                                <button class="btn btn-light add-model-btn" data-model-id="{{ model.id }}" data-model-name="{{ model.object }}" data-company="{{ model.owned_by }}" data-level="{{ model.min_tier }}" data-output="{{ model.pricing.output }}" onclick="addModel(this)">
                                    &#10010;
                                </button>
                                {% endif %}
                            </td>
                            <td>{{ model.id }}</td>
                            <td>{{ model.object }}</td>
                            <td>{{ model.owned_by }}</td>
                            <td>{{ model.min_tier }}</td>
                            <td>{{ model.mode }}</td>
                            <td>{{ model.supported_endpoints }}</td>
                            <td>{{ model.pricing }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
        </div>
           
        
    </div>
     <!-- Scroll to top button -->
    <button onclick="scrollToTop()" id="scrollToTopBtn">&#8593;</button>
    
    <!-- Hidden form for adding model -->
    <div id="add-model-form" style="display:none;">
        <form id="modelForm" action="{% url 'ai:add_model' %}" method="post">
            {% csrf_token %}
            <input type="text" name="name" id="modelName">
            <input type="text" name="label" id="modelLabel">
            <input type="text" name="company" id="modelCompany">
            <input type="number" name="level" id="modelLevel">
            <input type="number" name="output_token" id="modelOutputToken">
            <input type="submit" value="Add Model" class="btn btn-primary">
        </form>
    </div>
</div>
  
{% endblock content %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    // JavaScript function to handle adding model
    function addModel(button) {
        // Get data attributes from the button
        const modelId = button.getAttribute('data-model-id');
        const modelName = button.getAttribute('data-model-name');
        const company = button.getAttribute('data-company');
        const level = button.getAttribute('data-level');
        const output = button.getAttribute('data-output');

        // Populate the hidden form with the data
        document.getElementById('modelName').value = modelId;
        document.getElementById('modelLabel').value = modelId;
        document.getElementById('modelCompany').value = company;
        document.getElementById('modelLevel').value = level;
        document.getElementById('modelOutputToken').value = output;

        // Submit the form
        document.getElementById('modelForm').submit();
    }



    $(document).ready(function() {
        var lastMessageId = "{{ last_message_id }}"; // Get the value from the Django template

        if (lastMessageId) {
            // Scroll to the element with the specified ID
            $('html, body').animate({ // Animate the scroll
                scrollTop: $("#" + lastMessageId).offset().top
            }, 500); // Adjust the duration (in milliseconds) for the animation
        }
    });

    // JavaScript to show/hide and handle the scroll-to-top button
        window.onscroll = function() {
            scrollFunction();
        };

        function scrollFunction() {
            var scrollToTopBtn = document.getElementById("scrollToTopBtn");
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {                scrollToTopBtn.style.display = "block"; // Show the button
            } else {
                scrollToTopBtn.style.display = "none";  // Hide the button
            }
        }

        function scrollToTop() {
            // For modern browsers
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;

            // Optional: Add a smooth scrolling animation (using requestAnimationFrame for better performance)
            // function smoothScroll() {
            //     let currentPosition = document.documentElement.scrollTop || document.body.scrollTop;
            //     if (currentPosition > 0) {
            //         window.requestAnimationFrame(smoothScroll); // Request next animation frame
            //         window.scrollTo(0, currentPosition - currentPosition / 8); // Adjust scroll speed
            //     }
            // }
            // smoothScroll();
        }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select the container that holds the LLM responses
    const responseContainer = document.querySelector('.response-container');
    // const responseContainer = document.querySelector('.codehilite');
    console.log('Response container:', responseContainer);
    // Find all <pre> and <code> tags in the container
    const pres = responseContainer.querySelectorAll('pre');
    console.log('Find pres', pres.length)
    pres.forEach(pre => {
        // Create a copy button
        const button = document.createElement('button');
        // button.textContent = 'Copy to clipbaord';
        button.innerHTML = `<i class='fas fa-clipboard'></i>`;
        button.className = 'btn btn-primary'; // Add Bootstrap classes

        // Append the button next to the <pre> tag
        pre.parentNode.insertBefore(button, pre.nextSibling);

        // Add click event to the button
        button.addEventListener('click', function() {
            const codeContent = pre.innerText; // Get the content of the <pre>

            // Create a temporary textarea to copy from
            const tempInput = document.createElement('textarea');
            tempInput.value = codeContent;
            document.body.appendChild(tempInput);

            // Select the text and copy it
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy'); // Copy the text to clipboard

            // Clean up by removing the temporary element
            document.body.removeChild(tempInput);

            // Optionally, alert the user
            alert('Copied to clipboard!');
        });
    });
});
</script>

<style>
    /* Optional styles for the button */
    .btn {
        margin-top: 5px;
        margin-left: 5px;
        display: inline-block;
    }
    .response-container pre {
        border: #fff 1px solid;
        padding: 20px;
    }
    /* Style for the scroll-to-top button */
    #scrollToTopBtn {
        display: none; /* Initially hide the button */
        position: fixed; /* Fixed position (relative to the viewport) */
        bottom: 20px;   /* Distance from the bottom of the viewport */
        right: 20px;    /* Distance from the right of the viewport */
        background-color: #007bff; /* Example background color */
        color: white;             /* Example text color */
        border: none;              /* Remove border */
        border-radius: 50%;        /* Make it round */
        width: 50px;               /* Button size */
        height: 50px;              /* Button size */
        text-align: center;       /* Center text horizontally */
        line-height: 50px;        /* Center text vertically */
        cursor: pointer;            /* Change cursor to a pointer on hover */
        z-index: 1000;             /* Ensure it's above other content */
        font-size: 24px;
        font-weight: bold;
    }

    #scrollToTopBtn:hover {
        background-color: #0056b3; /* Darken the background on hover */
    }
</style>
  
{% endblock script %}
