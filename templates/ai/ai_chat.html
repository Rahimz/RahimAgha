{% extends "_base.html" %}
{% load crispy_forms_tags %}
{% load markdown_extras %} 

{% block content %}
<div class="container text-light">
    <div class="row">
        <div class="col">
            <div class="d-flex justify-left align-items-center my-3">
                {% include "ai/chat_header.html" %}
                
                <!-- Left column: button that opens offcanvas -->
                <!-- Toggle button (small tab / icon) -->
                <button class="btn btn-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#chatListOffcanvas" aria-controls="chatListOffcanvas" aria-expanded="false" aria-label="Open chats">
                    <i class="fas fa-comments"></i> Chats
                </button>
            </div>
            <!-- Offcanvas panel containing chat list -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="chatListOffcanvas" aria-labelledby="chatListOffcanvasLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="chatListOffcanvasLabel">Chats</h5>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <!-- Make the list scrollable and constrain height -->
                <div class="list-group" style="max-height: calc(100vh - 140px); overflow:auto;">
                {% for chat in chats %}
                    <a class="list-group-item list-group-item-action" href="{% url 'ai:ai_continue_chat' chat.chat_id %}">
                    {{ chat.get_first_message }}
                    </a>
                {% empty %}
                    <div class="list-group-item">No chats</div>
                {% endfor %}
                </div>
            </div>
            </div>

            <!-- chat title -->
            <div class="">
                {% if chat %}
                <h2>{{ chat.model_name }}</h2>
                <h4>{{ chat.chat_id }}</h4>
                {% endif %}
            </div>
            <!-- chat messages -->
            <div class="">
                {% for message in all_messages %}
                <div class="rounded">
                    <div class="d-flex justify-content-between align-items-center">
                        <div id="{{ message.id }}">
                            {% if message.role == 'user' %}
                                Prompt
                            {% else %}
                                Response
                            {% endif %}
                        </div>
                        <div style="flex-grow: 1; margin-left: 10px;">
                            <hr style="border: 0; border-top: 1px solid #fff;">
                        </div>
                    </div>

                    <div >
                        {% if message.role == 'user' %}                            

                        {{ message.content|linebreaksbr|truncatechars:700 }}
                        
                        {% if message.file %}
                        <br>
                        <i class="fas fa-paperclip text-dark"></i> {{ message.get_file_type_display }}: <a href="{{ message.file.url }}" download target="_blank">{{ message.file.name }}</a>
                        {% endif %}                            
                        <br>
                        <p class="gap-1">
                            <a class="btn btn-secondary" data-bs-toggle="collapse" href="#collapse{{ message.id }}" role="button" aria-expanded="false" aria-controls="collapse{{ message.id }}">
                                ...
                            </a>                        
                        </p>
                        <div class="collapse" id="collapse{{ message.id }}">
                            <div class="card card-body text-dark">
                                {{ message.content|linebreaksbr }}
                            </div>
                        </div>

                        {% elif message.role == 'assistant' %}
                        <div>
                            {% if message.file_type == image %}
                              <img src="{{ message.file.url }}" alt="" width="100%" height="auto">
                            {% endif %}
                        </div>
                        <div class="response-container">
                            {{ message.content|markdown|safe }}
                        </div>
                        <div class="text-danger">
                            {% if message.error %}
                              {{ message.error|safe }}
                            {% endif %}
                        </div> 
                        <br>
                        <p class="gap-1">
                            <a class="btn btn-secondary" data-bs-toggle="collapse" href="#collapse{{ message.id }}" role="button" aria-expanded="false" aria-controls="collapse{{ message.id }}">
                                ...
                            </a>                        
                        </p>
                        <div class="collapse" id="collapse{{ message.id }}">
                            <div class="">
                                {{ message.content|linebreaksbr }}
                            </div>
                        </div>
                        
                        {% else %}
                        --
                        {% endif %}
                    </div>
                </div>                    
            {% endfor %}
            
            <form action="" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form |crispy}}
                <input type="submit" value="Submit" class="btn btn-light my-2">
            </form>
        </div>
    </div>
     <!-- Scroll to top button -->
    <button onclick="scrollToTop()" id="scrollToTopBtn">&#8593;</button>
    
</div>
  
{% endblock content %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    $(document).ready(function() {
        var lastMessageId = "{{ last_message_id }}"; // Get the value from the Django template

        if (lastMessageId) {
            // Scroll to the element with the specified ID
            $('html, body').animate({ // Animate the scroll
                scrollTop: $("#" + lastMessageId).offset().top
            }, 500); // Adjust the duration (in milliseconds) for the animation
        }
    });

    // JavaScript to show/hide and handle the scroll-to-top button
        window.onscroll = function() {
            scrollFunction();
        };

        function scrollFunction() {
            var scrollToTopBtn = document.getElementById("scrollToTopBtn");
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {                scrollToTopBtn.style.display = "block"; // Show the button
            } else {
                scrollToTopBtn.style.display = "none";  // Hide the button
            }
        }

        function scrollToTop() {
            // For modern browsers
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;

             // Optional: Add a smooth scrolling animation (using requestAnimationFrame for better performance)
            // function smoothScroll() {
            //     let currentPosition = document.documentElement.scrollTop || document.body.scrollTop;
            //     if (currentPosition > 0) {
            //         window.requestAnimationFrame(smoothScroll); // Request next animation frame
            //         window.scrollTo(0, currentPosition - currentPosition / 8); // Adjust scroll speed
            //     }
            // }
            // smoothScroll();
        }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select the container that holds the LLM responses
    const responseContainer = document.querySelector('.response-container');
    // const responseContainer = document.querySelector('.codehilite');
    console.log('Response container:', responseContainer);
    // Find all <pre> and <code> tags in the container
    const pres = responseContainer.querySelectorAll('pre');
    console.log('Find pres', pres.length)
    pres.forEach(pre => {
        // Create a copy button
        const button = document.createElement('button');
        // button.textContent = 'Copy to clipbaord';
        button.innerHTML = `<i class='fas fa-clipboard'></i>`;
        button.className = 'btn btn-primary'; // Add Bootstrap classes

        // Append the button next to the <pre> tag
        pre.parentNode.insertBefore(button, pre.nextSibling);

        // Add click event to the button
        button.addEventListener('click', function() {
            const codeContent = pre.innerText; // Get the content of the <pre>

            // Create a temporary textarea to copy from
            const tempInput = document.createElement('textarea');
            tempInput.value = codeContent;
            document.body.appendChild(tempInput);

            // Select the text and copy it
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand('copy'); // Copy the text to clipboard

            // Clean up by removing the temporary element
            document.body.removeChild(tempInput);

            // Optionally, alert the user
            alert('Copied to clipboard!');
        });
    });
});
</script>

<style>
    /* Optional styles for the button */
    .btn {
        margin-top: 5px;
        margin-left: 5px;
        display: inline-block;
    }
    .response-container pre {
        border: #fff 1px solid;
        padding: 20px;
    }
    /* Style for the scroll-to-top button */
    #scrollToTopBtn {
        display: none; /* Initially hide the button */
        position: fixed; /* Fixed position (relative to the viewport) */
        bottom: 20px;   /* Distance from the bottom of the viewport */
        right: 20px;    /* Distance from the right of the viewport */
        background-color: #007bff; /* Example background color */
        color: white;             /* Example text color */
        border: none;              /* Remove border */
        border-radius: 50%;        /* Make it round */
        width: 50px;               /* Button size */
        height: 50px;              /* Button size */
        text-align: center;       /* Center text horizontally */
        line-height: 50px;        /* Center text vertically */
        cursor: pointer;            /* Change cursor to a pointer on hover */
        z-index: 1000;             /* Ensure it's above other content */
        font-size: 24px;
        font-weight: bold;
    }

    #scrollToTopBtn:hover {
        background-color: #0056b3; /* Darken the background on hover */
    }
</style>
  
{% endblock script %}
{% comment %}
      
    <table class="table">
        <tr>
            <td>{{ model_name }}</td>
            {% for message in messages %}
            <td> {{ message.content|markdown|safe }} </td>
            {% endfor %}
        </tr>
        <tr>
            <td>{{ai_message.usage_metadata}}</td>
            
        </tr>
        <tr>
            <td>{{ ai_message.id}}</td>
            <td>{{ ai_message.response_metadata.model_name }}</td>
            <td>{{ ai_message.response_metadata.completion_tokens }}</td>
            <td>{{ ai_message.response_metadata.prompt_tokens }}</td>
            <td>{{ ai_message.response_metadata.total_token }}</td>
            
            <td>
                {{ai_message.content|markdown|safe  }}
            </td>
        </tr>
        
    </table>
    <code>
        {% for item, value in ai_message %}
        {{ item }} | {{ value }}
        <hr>
        {% endfor %}
    </code>
{% endcomment %}